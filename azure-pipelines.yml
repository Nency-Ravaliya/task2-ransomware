trigger:
  branches:
    include:
      - main  # Trigger on updates to the main branch

pool:
  name: 'Default'  # Specify the agent pool
  demands:
    - agent.name -equals nensijsk  # Target the specific agent "nensijsk"

variables:
  dockerRegistryServiceConnection: 'task2-dockerhub-connection'  # Docker Hub service connection name
  imageNameApi: 'nensiravaliya28/ransomware-dashboard-api'
  imageNameFrontend: 'nensiravaliya28/ransomware-dashboard-frontend'
  azureWebAppName: 'task2-web-app'  # Azure Web App name
  dockerComposeFile: 'docker-compose.yml'

stages:

# Stage 1: Setup Node.js
- stage: Setup
  displayName: 'Setup Environment'
  jobs:
  - job: SetupNode
    displayName: 'Install Node.js'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '18.x'
        displayName: 'Install Node.js Version 16.x'

# Stage 2: Build Frontend
- stage: BuildFrontend
  displayName: 'Build Frontend'
  dependsOn: Setup
  jobs:
  - job: BuildReactApp
    displayName: 'Build React Application'
    steps:
      - script: |
          cd frontend
          npm install
          npm run build
        displayName: 'Install and Build React App'

# Stage 3: Build and Push Docker Images
- stage: DockerBuildAndPush
  displayName: 'Build and Push Docker Images'
  dependsOn: BuildFrontend
  jobs:
  - job: BuildAndPushFrontendImage
    displayName: 'Build and Push Frontend Docker Image'
    steps:
      - task: Docker@2
        inputs:
          containerRegistry: $(dockerRegistryServiceConnection)
          repository: $(imageNameFrontend)
          command: 'buildAndPush'
          Dockerfile: 'frontend/Dockerfile'  # Path to frontend Dockerfile
          tags: |
            latest
        displayName: 'Build and Push Frontend Docker Image to Docker Hub'

  - job: BuildAndPushApiImage
    displayName: 'Build and Push API Docker Image'
    steps:
      - task: Docker@2
        inputs:
          containerRegistry: $(dockerRegistryServiceConnection)
          repository: $(imageNameApi)
          command: 'buildAndPush'
          Dockerfile: 'Dockerfile.api'  # Path to API Dockerfile
          tags: |
            latest
        displayName: 'Build and Push API Docker Image to Docker Hub'
